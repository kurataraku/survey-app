# Supabase Storage設定ガイド

画像アップロード機能を使用するには、Supabase Storageのバケットを作成する必要があります。

## 📋 詳細な手順

### ステップ1: Supabaseダッシュボードにアクセス

1. ブラウザで [https://supabase.com](https://supabase.com) を開く
2. 右上の「**Sign In**」ボタンをクリックしてログイン
   - アカウントがない場合は「**Sign Up**」から新規登録
3. ログイン後、ダッシュボードが表示されます
4. 使用するプロジェクトを選択（プロジェクトカードをクリック）
   - 複数のプロジェクトがある場合は、該当するプロジェクトを選択してください

### ステップ2: Storageメニューに移動

1. 左側のサイドバーメニューを確認します
2. メニューの中から「**Storage**」という項目を探します
   - アイコンは通常、フォルダやファイルのアイコンです
   - メニューが折りたたまれている場合は、メニューを展開してください
3. 「**Storage**」をクリックします
4. Storageページが表示されます
   - 初めての場合は「No buckets yet」や「Create your first bucket」のようなメッセージが表示されることがあります

### ステップ3: 新しいバケットを作成

1. ページの上部または中央に「**New bucket**」というボタンがあります
   - 緑色や青色のボタンです
   - または「**Create bucket**」というボタンの場合もあります
2. 「**New bucket**」ボタンをクリックします
3. モーダルウィンドウ（ポップアップ）が表示されます
4. 以下の項目を入力・設定します：

   **a. Name（バケット名）**
   - 入力欄に `article-images` と入力してください
   - ⚠️ **重要**: `public` という名前はSupabaseの予約語のため使用できません
   - 推奨される名前: `article-images`, `images`, `uploads` など
   - 小文字とハイフン（-）のみ使用できます（大文字やアンダースコアは使用できません）
   - この名前は後で変更できませんので注意してください

   **b. Public bucket（公開バケット）**
   - チェックボックスがあります
   - **必ずチェックを入れてください**（✓マークが表示される状態にする）
   - これにより、アップロードした画像が公開URLでアクセス可能になります
   - チェックを入れないと、画像にアクセスできなくなります

   **c. File size limit（ファイルサイズ制限）**
   - 数値入力欄があります
   - `10` と入力してください（単位はMB）
   - これにより、10MB以下のファイルのみアップロード可能になります
   - より大きなファイルを許可したい場合は、数値を増やしてください

   **d. Allowed MIME types（許可するMIMEタイプ）**
   - テキスト入力欄があります
   - **この欄は空欄のままにしてください**
   - 空欄にすることで、すべての画像タイプ（JPG、PNG、GIFなど）を許可します
   - 特定のタイプのみ許可したい場合は、`image/jpeg,image/png,image/gif` のように入力できます

5. すべての設定が完了したら、モーダルウィンドウの下部にある「**Create bucket**」ボタンをクリックします
   - ボタンは緑色や青色の場合が多いです
   - または「**Create**」というボタンの場合もあります

### ステップ4: 作成の確認

1. バケットが正常に作成されると、Storageページに `article-images` という名前のバケットが表示されます
2. バケット名の横に「**Public**」というラベルが表示されていることを確認してください
   - これにより、バケットが公開設定になっていることが確認できます
3. もしエラーメッセージが表示された場合は：
   - 「Bucket name already exists」→ 既に同じ名前のバケットが存在します（別の名前を試してください）
   - 「"public" is a reserved name」→ `public` という名前は使用できません。別の名前を使用してください
   - その他のエラー → エラーメッセージの内容を確認し、設定を見直してください

### ステップ5: 環境変数の設定（必須）

作成したバケット名をアプリケーションに認識させるため、環境変数を設定する必要があります：

1. プロジェクトのルートディレクトリ（`survey-app`フォルダ）にある `.env.local` ファイルを開きます
   - ファイルが見つからない場合は、新規作成してください
2. ファイルに以下を追加します（既に他の環境変数がある場合は、新しい行に追加）：
   ```env
   SUPABASE_STORAGE_BUCKET=article-images
   ```
3. もし `article-images` 以外の名前でバケットを作成した場合は、その名前に置き換えます
   - 例: `SUPABASE_STORAGE_BUCKET=images`
   - 例: `SUPABASE_STORAGE_BUCKET=uploads`
4. ファイルを保存します
5. ⚠️ **重要**: 環境変数を変更した後は、開発サーバーを再起動する必要があります

### ステップ6: 動作確認

1. ターミナル（コマンドプロンプト）を開きます
2. プロジェクトのディレクトリに移動します（まだ移動していない場合）
   ```bash
   cd survey-app
   ```
3. 開発サーバーを停止します（実行中の場合）
   - `Ctrl + C` を押して停止
4. 開発サーバーを再起動します：
   ```bash
   npm run dev
   ```
5. ブラウザで記事編集ページを開きます：
   - URL例: `http://localhost:3000/admin/articles/[記事ID]/edit`
6. 「アイキャッチ画像」のセクションを確認します
7. 画像をアップロードしてみます：
   - **方法1**: 画像ファイルをドラッグ&ドロップ
   - **方法2**: エリアをクリックしてファイル選択ダイアログから画像を選択
8. アップロードが成功すると、画像のプレビューが表示されます
9. エラーが表示される場合は、以下のトラブルシューティングを参照してください

## ⚠️ トラブルシューティング

### エラー: "Storageバケット 'article-images' が存在しません"

**原因**: Storageバケットが作成されていない、または環境変数が正しく設定されていない

**解決方法**: 
1. 上記のステップ3に従ってバケットを作成してください
2. ステップ5に従って環境変数を設定してください
3. 開発サーバーを再起動してください

### エラー: ""public" is a reserved name. Please choose another name"

**原因**: `public` という名前はSupabaseの予約語のため使用できません

**解決方法**: 
1. 別のバケット名を使用してください（例: `article-images`, `images`, `uploads`）
2. ステップ5に従って環境変数を設定してください
3. 開発サーバーを再起動してください

### エラー: "バケットへのアクセス権限がありません"

**原因**: バケットが公開設定になっていない

**解決方法**: 
1. Supabaseダッシュボード → Storage → バケット名をクリック
2. 「Settings」タブを開く
3. 「Public bucket」が有効になっているか確認
4. 無効の場合は有効にする

### エラー: "ファイルサイズは10MB以下である必要があります"

**原因**: アップロードしようとしたファイルが10MBを超えている

**解決方法**: 
- 画像を圧縮するか、より小さいファイルを使用してください
- または、バケットの「File size limit」を増やす（上記手順2参照）

## 📝 注意事項

- バケット名は小文字とハイフンのみ使用できます
- 公開バケットにアップロードされた画像は、URLを知っている誰でもアクセスできます
- 機密性の高い画像の場合は、非公開バケットと認証を使用することを検討してください

